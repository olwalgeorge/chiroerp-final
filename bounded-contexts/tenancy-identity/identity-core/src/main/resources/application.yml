# Identity Core runtime baseline (pre-MVP implementation)
# ADR-005: tenant-aware identity data isolation
# ADR-006: shared kernel governance (technical primitives only in platform-shared)
# ADR-007: authentication/authorization strategy integration point

quarkus:
  application:
    name: identity-core
  http:
    host: 0.0.0.0
    port: ${IDENTITY_CORE_HTTP_PORT:8072}
  container-image:
    group: chiroerp
    name: identity-core
    tag: latest
    build: true
  datasource:
    db-kind: postgresql
    username: ${POSTGRES_IDENTITY_USER:svc_identity_core}
    password: ${POSTGRES_IDENTITY_PASSWORD:dev_password}
    jdbc:
      url: jdbc:postgresql://${POSTGRES_HOST:localhost}:${POSTGRES_PORT:5432}/${POSTGRES_DATABASE:chiroerp}?currentSchema=${POSTGRES_IDENTITY_SCHEMA:identity_core}
      max-size: ${DB_POOL_MAX_SIZE:20}
      min-size: ${DB_POOL_MIN_IDLE:5}
  hibernate-orm:
    schema-management:
      strategy: none
    log:
      sql: false
  flyway:
    migrate-at-start: true
    baseline-on-migrate: true
    locations: classpath:db/migration
    schemas: ${POSTGRES_IDENTITY_SCHEMA:identity_core}
    table: flyway_history_identity_core
  redis:
    hosts: redis://:${REDIS_PASSWORD:dev_password}@${REDIS_HOST:localhost}:${REDIS_PORT:6379}
  micrometer:
    export:
      prometheus:
        enabled: true
  log:
    level: ${LOG_LEVEL:INFO}
    console:
      json:
        enabled: true
  smallrye-health:
    root-path: /q/health
  smallrye-openapi:
    path: /q/openapi
    store-schema-directory: build/openapi
    store-schema-file-name: openapi
  swagger-ui:
    path: /q/swagger-ui
    always-include: true

mp:
  openapi:
    extensions:
      smallrye:
        info:
          title: ChiroERP Identity API
          version: 1.0.0
          description: Authentication, user management, and MFA API
          contact:
            name: ChiroERP API Team
            email: api@chiroerp.example.com
            url: https://github.com/olwalgeorge/chiroerp-final
          license:
            name: Proprietary
        operationIdStrategy: METHOD

kafka:
  bootstrap:
    servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:19092}

chiroerp:
  identity:
    jwt:
      issuer: ${IDENTITY_JWT_ISSUER:identity-core}
      secret: ${IDENTITY_JWT_SECRET:change-me-identity-jwt-secret}
      default-ttl-seconds: ${IDENTITY_JWT_DEFAULT_TTL_SECONDS:900}
      access-ttl-seconds: ${IDENTITY_JWT_ACCESS_TTL_SECONDS:900}
      refresh-ttl-seconds: ${IDENTITY_JWT_REFRESH_TTL_SECONDS:2592000}
    mfa:
      issuer: ${IDENTITY_MFA_ISSUER:ChiroERP}
      backup-code-count: ${IDENTITY_MFA_BACKUP_CODE_COUNT:8}
      totp:
        digits: ${IDENTITY_MFA_TOTP_DIGITS:6}
        time-step-seconds: ${IDENTITY_MFA_TOTP_STEP_SECONDS:30}
        secret-bytes: ${IDENTITY_MFA_TOTP_SECRET_BYTES:20}
    password:
      min-length: ${IDENTITY_PASSWORD_MIN_LENGTH:12}
      max-length: ${IDENTITY_PASSWORD_MAX_LENGTH:72}
      require-uppercase: true
      require-lowercase: true
      require-digit: true
      require-symbol: true
      forbid-whitespace: true
      bcrypt-cost: ${IDENTITY_PASSWORD_BCRYPT_COST:12}
      denylist:
        - Password123!
        - Welcome123!
        - Chiroerp2025!
  messaging:
    identity-events:
      topic: ${IDENTITY_EVENTS_TOPIC:identity.user.lifecycle}
      outbox:
        enabled: ${IDENTITY_OUTBOX_ENABLED:true}
        batch-size: ${IDENTITY_OUTBOX_BATCH_SIZE:100}
        poll-interval: ${IDENTITY_OUTBOX_POLL_INTERVAL:5s}
        max-backoff-seconds: ${IDENTITY_OUTBOX_MAX_BACKOFF_SECONDS:60}
        max-attempts: ${IDENTITY_OUTBOX_MAX_ATTEMPTS:10}
        metrics-refresh-interval: ${IDENTITY_OUTBOX_METRICS_REFRESH_INTERVAL:30s}
        pending-threshold: ${IDENTITY_OUTBOX_PENDING_THRESHOLD:500}
        dead-threshold: ${IDENTITY_OUTBOX_DEAD_THRESHOLD:0}
    tenancy-events:
      topic: ${TENANCY_EVENTS_TOPIC:chiroerp.tenancy.events}
      consumer:
        enabled: ${TENANCY_EVENTS_CONSUMER_ENABLED:true}
        group-id: ${TENANCY_EVENTS_CONSUMER_GROUP_ID:identity-core-tenancy-events}
        poll-interval: ${TENANCY_EVENTS_CONSUMER_POLL_INTERVAL:2s}
        poll-timeout-ms: ${TENANCY_EVENTS_CONSUMER_POLL_TIMEOUT_MS:750}
        max-records: ${TENANCY_EVENTS_CONSUMER_MAX_RECORDS:100}
        auto-offset-reset: ${TENANCY_EVENTS_CONSUMER_AUTO_OFFSET_RESET:latest}
      bootstrap-admin:
        enabled: ${TENANCY_EVENTS_BOOTSTRAP_ADMIN_ENABLED:true}
        email-prefix: ${TENANCY_EVENTS_BOOTSTRAP_ADMIN_EMAIL_PREFIX:admin}
        first-name: ${TENANCY_EVENTS_BOOTSTRAP_ADMIN_FIRST_NAME:Tenant}
        last-name: ${TENANCY_EVENTS_BOOTSTRAP_ADMIN_LAST_NAME:Admin}
        locale: ${TENANCY_EVENTS_BOOTSTRAP_ADMIN_LOCALE:en-US}
        time-zone-id: ${TENANCY_EVENTS_BOOTSTRAP_ADMIN_TIMEZONE:UTC}
        role-code: ${TENANCY_EVENTS_BOOTSTRAP_ADMIN_ROLE_CODE:TENANT_ADMIN}
      user-sync:
        batch-size: ${TENANCY_EVENTS_USER_SYNC_BATCH_SIZE:200}
