# AsyncAPI Governance Workflow
# Validates and lints AsyncAPI specifications for event-driven APIs
#
# Triggered on:
#   - Push/PR changes to AsyncAPI spec files
#   - Manual workflow dispatch

name: AsyncAPI Governance

on:
  push:
    branches: [main, develop]
    paths:
      - 'config/asyncapi/**'
      - '.github/workflows/asyncapi-lint.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'config/asyncapi/**'
      - '.github/workflows/asyncapi-lint.yml'
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: asyncapi-${{ github.ref }}
  cancel-in-progress: true

env:
  # Pin CLI versions for reproducible builds
  ASYNCAPI_CLI_VERSION: 2.3.0
  SPECTRAL_CLI_VERSION: 6.11.1

jobs:
  validate-asyncapi:
    name: Validate AsyncAPI Specs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install AsyncAPI CLI
        run: |
          npm install -g @asyncapi/cli@${{ env.ASYNCAPI_CLI_VERSION }}
          asyncapi --version
      
      - name: Validate AsyncAPI specifications
        run: |
          echo "üîç Validating AsyncAPI specifications..."
          SPECS_FOUND=0
          ERRORS=0
          
          for spec in config/asyncapi/*.yaml config/asyncapi/*.yml; do
            if [ -f "$spec" ]; then
              SPECS_FOUND=$((SPECS_FOUND + 1))
              echo ""
              echo "üìã Validating: $spec"
              if asyncapi validate "$spec" --fail-severity=error; then
                echo "‚úÖ Valid: $spec"
              else
                echo "‚ùå Invalid: $spec"
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done
          
          echo ""
          echo "üìä Validation Summary"
          echo "===================="
          echo "Specs validated: $SPECS_FOUND"
          echo "Errors: $ERRORS"
          
          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi
  
  lint-asyncapi:
    name: Lint AsyncAPI Specs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate-asyncapi
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Spectral CLI
        run: |
          npm install -g @stoplight/spectral-cli@${{ env.SPECTRAL_CLI_VERSION }}
          spectral --version
      
      - name: Create AsyncAPI ruleset
        run: |
          cat > .spectral-asyncapi.yaml << 'EOF'
          extends:
            - "asyncapi:recommended"
          
          rules:
            # Require info description
            asyncapi-info-description:
              severity: error
            
            # Require operation summaries
            asyncapi-operation-summary:
              severity: warn
            
            # Enforce consistent message naming
            asyncapi-message-messageId:
              severity: warn
            
            # Schema best practices
            asyncapi-schema-examples:
              severity: hint
          EOF
      
      - name: Lint AsyncAPI specifications
        run: |
          echo "üîç Linting AsyncAPI specifications..."
          SPECS_FOUND=0
          ERRORS=0
          
          for spec in config/asyncapi/*.yaml config/asyncapi/*.yml; do
            if [ -f "$spec" ]; then
              SPECS_FOUND=$((SPECS_FOUND + 1))
              echo ""
              echo "üìã Linting: $spec"
              if spectral lint "$spec" --ruleset .spectral-asyncapi.yaml --fail-severity=error; then
                echo "‚úÖ Passed: $spec"
              else
                echo "‚ö†Ô∏è Issues in: $spec"
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done
          
          echo ""
          echo "üìä Lint Summary"
          echo "==============="
          echo "Specs linted: $SPECS_FOUND"
          echo "Errors: $ERRORS"
          
          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi
  
  generate-docs:
    name: Generate AsyncAPI Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate-asyncapi, lint-asyncapi]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install AsyncAPI CLI
        run: npm install -g @asyncapi/cli@${{ env.ASYNCAPI_CLI_VERSION }}
      
      - name: Generate HTML documentation
        run: |
          mkdir -p build/asyncapi-docs
          
          for spec in config/asyncapi/*.yaml config/asyncapi/*.yml; do
            if [ -f "$spec" ]; then
              BASENAME=$(basename "$spec" | sed 's/\.[^.]*$//')
              echo "üìÑ Generating docs for: $BASENAME"
              asyncapi generate fromTemplate "$spec" @asyncapi/html-template -o "build/asyncapi-docs/$BASENAME" --force-write
            fi
          done
      
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: asyncapi-documentation
          path: build/asyncapi-docs/
          retention-days: 30

  breaking-change-check:
    name: Check Breaking Changes
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr-branch
      
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base-branch
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install AsyncAPI CLI
        run: npm install -g @asyncapi/cli@${{ env.ASYNCAPI_CLI_VERSION }}
      
      - name: Check for breaking changes
        run: |
          echo "üîç Checking for breaking changes in AsyncAPI specs..."
          BREAKING_CHANGES=0
          
          for spec in pr-branch/config/asyncapi/*.yaml pr-branch/config/asyncapi/*.yml; do
            if [ -f "$spec" ]; then
              BASENAME=$(basename "$spec")
              BASE_SPEC="base-branch/config/asyncapi/$BASENAME"
              
              if [ -f "$BASE_SPEC" ]; then
                echo ""
                echo "üìã Comparing: $BASENAME"
                
                # Use asyncapi diff to detect breaking changes
                if asyncapi diff "$BASE_SPEC" "$spec" --overrides breaking=fail 2>&1; then
                  echo "‚úÖ No breaking changes in: $BASENAME"
                else
                  echo "‚ö†Ô∏è Potential breaking changes in: $BASENAME"
                  BREAKING_CHANGES=$((BREAKING_CHANGES + 1))
                fi
              else
                echo "üìù New spec: $BASENAME (no base to compare)"
              fi
            fi
          done
          
          echo ""
          echo "üìä Breaking Change Summary"
          echo "=========================="
          echo "Specs with potential breaking changes: $BREAKING_CHANGES"
          
          if [ $BREAKING_CHANGES -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è Breaking changes detected. Please review carefully."
            echo "   Consider semantic versioning for event schemas."
            # Exit with warning but don't fail the workflow
            exit 0
          fi
