# =============================================================================
# CI Pipeline — SAP-Grade Build & Test (ADR-008 v3.1 Compliance)
# =============================================================================
# Architecture: cache-warmup → lint + architecture → build → integration +
#               security → status-gate
#
# Features:
#   ✅ Network resilience (nick-fields/retry@v3.0.0)
#   ✅ Cache warmup (dependency pre-fetch)
#   ✅ Log gate scanning (scripts/ci/log-gate.sh)
#   ✅ Security scanning (Trivy + OWASP)
#   ✅ Version pinning (all actions pinned to semver)
#   ✅ Least-privilege permissions
#   ✅ Concurrency controls
#   ✅ Per-job timeout limits
#   ✅ Parallel execution where safe
#
# References:
#   - ADR-008: CI/CD Pipeline Architecture and Network Resilience
#   - ADR-006: Platform Shared Governance Rules
#   - ADR-001: Modular CQRS Architecture
# =============================================================================

name: CI Pipeline

on:
  push:
    branches: [master, develop, 'feature/**']
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'config/asyncapi/**'
      - 'config/grafana/**'
      - 'config/prometheus/**'
      - '.github/workflows/api-governance.yml'
      - '.github/workflows/ci-docs.yml'
      - '.github/workflows/progress-tracker.yml'
  pull_request:
    branches: [master, develop]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'config/asyncapi/**'
      - 'config/grafana/**'
      - 'config/prometheus/**'

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ci-pipeline-${{ github.ref }}
  cancel-in-progress: true

# Least-privilege permissions (ADR-008)
permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'
  GRADLE_OPTS: >-
    -Dorg.gradle.configuration-cache=true
    -Dorg.gradle.daemon=false
    -Dorg.gradle.parallel=true
    -Dorg.gradle.caching=true

# =============================================================================
# Stage 1: Cache Warmup — Pre-fetch dependencies with retry
# =============================================================================
jobs:
  cache-warmup:
    name: Cache Warmup
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4.2.1
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v3.5.0

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Pre-fetch dependencies (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 6
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            ./gradlew dependencies --no-daemon --stacktrace 2>&1 | tail -20 || \
            ./gradlew help --no-daemon --stacktrace

      - name: Cleanup Gradle lock files
        if: always()
        run: |
          rm -f ~/.gradle/caches/modules-2/modules-2.lock
          rm -f ~/.gradle/caches/modules-2/gc.properties

# =============================================================================
# Stage 2: Lint + Architecture (parallel) — depends on cache-warmup
# =============================================================================
  lint:
    name: Lint & Code Style
    runs-on: ubuntu-latest
    needs: cache-warmup
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4.2.1
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Detekt static analysis (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 8
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            ./gradlew detekt --stacktrace || echo "⚠️ Detekt not yet configured — skipping"

      - name: Run ktlint check (with retry)
        if: false  # TODO: Enable when ktlint is configured in build-logic
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 8
          max_attempts: 3
          retry_wait_seconds: 10
          command: ./gradlew ktlintCheck --stacktrace

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v4.3.6
        with:
          name: lint-reports
          path: |
            **/build/reports/detekt/**
            **/build/reports/ktlint/**
          retention-days: 14
          if-no-files-found: ignore

  validate-architecture:
    name: Architecture Validation
    runs-on: ubuntu-latest
    needs: cache-warmup
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4.2.1
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run ArchUnit architecture tests (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 12
          max_attempts: 3
          retry_wait_seconds: 10
          command: ./gradlew validateArchitecture --stacktrace

      - name: Validate project structure (ADR compliance)
        run: |
          if [[ -f scripts/validate-complete-structure.sh ]]; then
            chmod +x scripts/validate-complete-structure.sh
            ./scripts/validate-complete-structure.sh
          else
            echo "ℹ️ Structure validation script not found — skipping"
          fi

      - name: Log gate scan
        if: always()
        run: |
          chmod +x scripts/ci/log-gate.sh
          ./scripts/ci/log-gate.sh scripts/ci/error-allowlist.txt . || true

      - name: Upload architecture reports
        if: always()
        uses: actions/upload-artifact@v4.3.6
        with:
          name: architecture-reports
          path: |
            **/build/reports/tests/**
            architecture-tests/build/reports/**
          retention-days: 14
          if-no-files-found: ignore

# =============================================================================
# Stage 3: Build & Unit Tests — depends on lint + architecture
# =============================================================================
  build:
    name: Build & Unit Tests
    runs-on: ubuntu-latest
    needs: [lint, validate-architecture]
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7
        with:
          fetch-depth: 0

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4.2.1
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build all modules (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 25
          max_attempts: 3
          retry_wait_seconds: 15
          command: |
            ./gradlew buildAll \
              --build-cache \
              --parallel \
              --stacktrace

      - name: Run unit tests (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 15
          command: |
            ./gradlew test \
              --continue \
              --stacktrace

      - name: Log gate scan
        if: always()
        run: |
          chmod +x scripts/ci/log-gate.sh
          ./scripts/ci/log-gate.sh scripts/ci/error-allowlist.txt . || true

      - name: Generate test report
        if: always()
        uses: dorny/test-reporter@v1.9.1
        with:
          name: Unit Test Results
          path: '**/build/test-results/test/*.xml'
          reporter: java-junit
          fail-on-error: true

      - name: Generate code coverage
        if: success()
        run: ./gradlew jacocoTestReport --stacktrace
        continue-on-error: true

      - name: Upload coverage to Codecov
        if: success()
        uses: codecov/codecov-action@v4.5.0
        with:
          files: '**/build/reports/jacoco/test/jacocoTestReport.xml'
          flags: unittests
          name: codecov-chiroerp
          fail_ci_if_error: false
        continue-on-error: true

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4.3.6
        with:
          name: build-artifacts
          path: |
            **/build/libs/*.jar
            **/build/quarkus-app/**
          retention-days: 7
          if-no-files-found: warn

      - name: Cleanup Gradle cache
        if: always()
        run: |
          rm -f ~/.gradle/caches/modules-2/modules-2.lock
          rm -f ~/.gradle/caches/modules-2/gc.properties

# =============================================================================
# Stage 4: Integration Tests + Security Scan (parallel) — depends on build
# =============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    services:
      postgres-finance:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: finance
          POSTGRES_USER: chiroerp
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      postgres-tenancy:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: tenancy
          POSTGRES_USER: chiroerp
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4.2.1
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Start Kafka (Redpanda)
        run: |
          docker run -d \
            --name redpanda \
            -p 9092:9092 \
            -p 9644:9644 \
            docker.redpanda.com/vectorized/redpanda:latest \
            redpanda start \
            --overprovisioned \
            --smp 1 \
            --memory 1G \
            --reserve-memory 0M \
            --node-id 0 \
            --check=false \
            --kafka-addr PLAINTEXT://0.0.0.0:9092 \
            --advertise-kafka-addr PLAINTEXT://localhost:9092

      - name: Wait for services
        run: |
          echo "⏳ Waiting for PostgreSQL (finance)..."
          timeout 30 bash -c 'until pg_isready -h localhost -p 5432; do sleep 1; done'

          echo "⏳ Waiting for PostgreSQL (tenancy)..."
          timeout 30 bash -c 'until pg_isready -h localhost -p 5433; do sleep 1; done'

          echo "⏳ Waiting for Redis..."
          timeout 30 bash -c 'until redis-cli -h localhost ping; do sleep 1; done'

          echo "⏳ Waiting for Kafka (Redpanda)..."
          sleep 10

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run integration tests (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 15
          command: |
            ./gradlew integrationTest \
              --continue \
              --stacktrace
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_PASSWORD: test_password
          KAFKA_BOOTSTRAP_SERVERS: localhost:9092
          REDIS_HOST: localhost

      - name: Log gate scan
        if: always()
        run: |
          chmod +x scripts/ci/log-gate.sh
          ./scripts/ci/log-gate.sh scripts/ci/error-allowlist.txt . || true

      - name: Generate integration test report
        if: always()
        uses: dorny/test-reporter@v1.9.1
        with:
          name: Integration Test Results
          path: '**/build/test-results/integrationTest/*.xml'
          reporter: java-junit
          fail-on-error: true

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4.3.6
        with:
          name: integration-test-logs
          path: |
            **/build/reports/tests/integrationTest/**
            **/build/test-results/integrationTest/**
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4.2.1
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: OWASP Dependency Check (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 15
          command: ./gradlew dependencyCheckAnalyze --stacktrace
        continue-on-error: true

      - name: Upload OWASP report
        if: always()
        uses: actions/upload-artifact@v4.3.6
        with:
          name: owasp-security-report
          path: build/reports/dependency-check-report.html
          retention-days: 30
          if-no-files-found: ignore

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3.25.11
        with:
          sarif_file: 'trivy-results.sarif'

# =============================================================================
# Stage 5: Status Gate — Final pipeline summary (ADR-008)
# =============================================================================
  status-gate:
    name: Pipeline Status Gate
    runs-on: ubuntu-latest
    needs: [cache-warmup, lint, validate-architecture, build, integration-tests, security-scan]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Evaluate pipeline status
        run: |
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║  CI Pipeline — Status Gate (ADR-008)                        ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          echo "  Cache Warmup:       ${{ needs.cache-warmup.result }}"
          echo "  Lint:               ${{ needs.lint.result }}"
          echo "  Architecture:       ${{ needs.validate-architecture.result }}"
          echo "  Build & Tests:      ${{ needs.build.result }}"
          echo "  Integration Tests:  ${{ needs.integration-tests.result }}"
          echo "  Security Scan:      ${{ needs.security-scan.result }}"
          echo ""

          # Hard gates (must pass)
          if [[ "${{ needs.cache-warmup.result }}" != "success" ]]; then
            echo "❌ FAILED: Cache warmup did not succeed"
            exit 1
          fi

          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "❌ FAILED: Lint checks did not pass"
            exit 1
          fi

          if [[ "${{ needs.validate-architecture.result }}" != "success" ]]; then
            echo "❌ FAILED: Architecture validation did not pass"
            exit 1
          fi

          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "❌ FAILED: Build & unit tests did not pass"
            exit 1
          fi

          if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "❌ FAILED: Integration tests did not pass"
            exit 1
          fi

          # Soft gate (security scan is advisory, not blocking)
          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "⚠️  WARNING: Security scan did not pass (advisory — not blocking)"
          fi

          echo "✅ Pipeline PASSED — all quality gates satisfied"

      - name: Post failure notification
        if: failure()
        run: |
          echo "::error::CI Pipeline failed for ${{ github.ref_name }} (commit: ${{ github.sha }}, author: ${{ github.actor }})"
