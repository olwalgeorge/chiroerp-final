# =============================================================================
# API Governance ‚Äî OpenAPI + AsyncAPI Validation (ADR-008, ADR-010)
# =============================================================================
# Unified API contract governance workflow that validates both REST (OpenAPI)
# and event-driven (AsyncAPI) specifications.
#
# Architecture:
#   generate-openapi-specs ‚Üí lint-openapi (Redocly + Spectral parallel)
#   validate-asyncapi-specs ‚Üí lint-asyncapi
#   All gates ‚Üí generate-docs (master only)
#                breaking-change-check (PR only)
#
# Features:
#   ‚úÖ Network resilience (nick-fields/retry@v3.0.0)
#   ‚úÖ Version pinning (all tools + actions pinned)
#   ‚úÖ Concurrency controls
#   ‚úÖ Per-job timeout limits
#   ‚úÖ Least-privilege permissions
#   ‚úÖ Breaking change detection on PRs
#   ‚úÖ Static doc generation on master
#
# References:
#   - ADR-008: CI/CD Pipeline Architecture
#   - ADR-010: REST Validation Standard
#   - ADR-003: Event-Driven Integration
# =============================================================================

name: API Governance

on:
  push:
    branches: [master, develop]
    paths:
      - 'bounded-contexts/**/src/main/kotlin/**/*Controller.kt'
      - 'bounded-contexts/**/src/main/kotlin/**/*Resource.kt'
      - 'bounded-contexts/**/src/main/kotlin/**/infrastructure/web/**/*.kt'
      - 'bounded-contexts/**/src/main/resources/application*.yml'
      - 'bounded-contexts/**/src/main/resources/application*.yaml'
      - 'config/asyncapi/**'
      - '.redocly.yaml'
      - '.spectral-asyncapi.yaml'
      - '.github/workflows/api-governance.yml'
  pull_request:
    branches: [master, develop]
    paths:
      - 'bounded-contexts/**/src/main/kotlin/**/*Controller.kt'
      - 'bounded-contexts/**/src/main/kotlin/**/*Resource.kt'
      - 'bounded-contexts/**/src/main/kotlin/**/infrastructure/web/**/*.kt'
      - 'bounded-contexts/**/src/main/resources/application*.yml'
      - 'bounded-contexts/**/src/main/resources/application*.yaml'
      - 'config/asyncapi/**'
      - '.redocly.yaml'
      - '.spectral-asyncapi.yaml'
      - '.github/workflows/api-governance.yml'
  workflow_dispatch:

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: api-governance-${{ github.ref }}
  cancel-in-progress: true

# Least-privilege permissions (ADR-008)
permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  REDOCLY_CLI_VERSION: '1.25.5'
  SPECTRAL_CLI_VERSION: '6.11.1'
  ASYNCAPI_CLI_VERSION: '2.3.0'
  NODE_VERSION: '20'

# =============================================================================
# OpenAPI Pipeline
# =============================================================================
jobs:
  generate-openapi-specs:
    name: Generate OpenAPI Specifications
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Setup Java 21
        uses: actions/setup-java@v4.2.1
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Generate OpenAPI specs (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            ./gradlew generateOpenApiSpecs --parallel --stacktrace
        env:
          GRADLE_OPTS: '-Dorg.gradle.daemon=false'

      - name: Summarize generated specs
        run: |
          echo "### Generated OpenAPI Specifications" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find . \( -path '*/build/openapi/openapi.yaml' \
                  -o -path '*/build/openapi/openapi.yml' \
                  -o -path '*/build/openapi/openapi.json' \) \
            | sort >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload OpenAPI specs
        uses: actions/upload-artifact@v4.3.6
        with:
          name: openapi-specs
          path: |
            **/build/openapi/openapi.yaml
            **/build/openapi/openapi.yml
            **/build/openapi/openapi.json
          retention-days: 30

  lint-openapi-redocly:
    name: Lint OpenAPI with Redocly
    needs: generate-openapi-specs
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Download OpenAPI specs
        uses: actions/download-artifact@v4.1.8
        with:
          name: openapi-specs
          path: openapi-specs

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Redocly CLI (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 3
          max_attempts: 3
          retry_wait_seconds: 10
          command: npm install -g @redocly/cli@${{ env.REDOCLY_CLI_VERSION }} --prefer-offline --no-audit --no-fund

      - name: Lint all OpenAPI specs
        run: |
          echo "### Redocly Lint Results" >> $GITHUB_STEP_SUMMARY
          specs=$(find openapi-specs \( -name 'openapi.yaml' -o -name 'openapi.yml' -o -name 'openapi.json' \))
          if [ -z "$specs" ]; then
            echo "‚ö†Ô∏è No OpenAPI specs found to lint" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          spec_count=$(echo "$specs" | wc -l | tr -d ' ')
          echo "‚úÖ Linting **$spec_count** spec(s)" >> $GITHUB_STEP_SUMMARY
          redocly lint $specs --format=stylish

  lint-openapi-spectral:
    name: Lint OpenAPI with Spectral
    needs: generate-openapi-specs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true  # Advisory ‚Äî Spectral is supplementary to Redocly

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Download OpenAPI specs
        uses: actions/download-artifact@v4.1.8
        with:
          name: openapi-specs
          path: openapi-specs

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Spectral CLI (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 3
          max_attempts: 3
          retry_wait_seconds: 10
          command: npm install -g @stoplight/spectral-cli@${{ env.SPECTRAL_CLI_VERSION }} --prefer-offline --no-audit --no-fund

      - name: Create Spectral ruleset
        run: |
          cat > .spectral.yaml << 'EOF'
          extends: spectral:oas
          rules:
            operation-success-response: error
            operation-operationId: error
            operation-description: error
          EOF

      - name: Lint with Spectral
        run: |
          echo "### Spectral Lint Results" >> $GITHUB_STEP_SUMMARY
          specs=$(find openapi-specs \( -name 'openapi.yaml' -o -name 'openapi.yml' -o -name 'openapi.json' \))
          for spec in $specs; do
            echo "üìã **$spec**" >> $GITHUB_STEP_SUMMARY
            spectral lint "$spec" --format=stylish || true
          done

# =============================================================================
# AsyncAPI Pipeline
# =============================================================================
  validate-asyncapi-specs:
    name: Validate AsyncAPI Specs
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install AsyncAPI CLI (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 3
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            npm install -g @asyncapi/cli@${{ env.ASYNCAPI_CLI_VERSION }}
            asyncapi --version

      - name: Validate AsyncAPI specifications
        run: |
          echo "### AsyncAPI Validation Results" >> $GITHUB_STEP_SUMMARY
          SPECS_FOUND=0
          ERRORS=0

          for spec in config/asyncapi/*.yaml config/asyncapi/*.yml; do
            if [ -f "$spec" ]; then
              SPECS_FOUND=$((SPECS_FOUND + 1))
              echo "üìã Validating: $spec"
              if asyncapi validate "$spec" --fail-severity=error; then
                echo "‚úÖ Valid: $spec"
              else
                echo "‚ùå Invalid: $spec"
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Specs validated:** $SPECS_FOUND | **Errors:** $ERRORS" >> $GITHUB_STEP_SUMMARY

          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

  lint-asyncapi:
    name: Lint AsyncAPI Specs
    runs-on: ubuntu-latest
    needs: validate-asyncapi-specs
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Spectral CLI and rulesets (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 3
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            npm install -g @stoplight/spectral-cli@${{ env.SPECTRAL_CLI_VERSION }}
            # Install rulesets locally so Spectral can resolve asyncapi:recommended
            npm init -y
            npm install @stoplight/spectral-rulesets
            spectral --version

      - name: Create AsyncAPI ruleset
        run: |
          cat > .spectral-asyncapi.yaml << 'EOF'
          extends:
            - "asyncapi:recommended"
          rules:
            asyncapi-info-description:
              severity: error
            asyncapi-operation-summary:
              severity: warn
            asyncapi-message-messageId:
              severity: warn
            asyncapi-schema-examples:
              severity: hint
          EOF

      - name: Lint AsyncAPI specifications
        run: |
          echo "### AsyncAPI Lint Results" >> $GITHUB_STEP_SUMMARY
          SPECS_FOUND=0
          ERRORS=0

          for spec in config/asyncapi/*.yaml config/asyncapi/*.yml; do
            if [ -f "$spec" ]; then
              SPECS_FOUND=$((SPECS_FOUND + 1))
              echo "üìã Linting: $spec"
              if spectral lint "$spec" --ruleset .spectral-asyncapi.yaml --fail-severity=error; then
                echo "‚úÖ Passed: $spec"
              else
                echo "‚ö†Ô∏è Issues in: $spec"
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Specs linted:** $SPECS_FOUND | **Errors:** $ERRORS" >> $GITHUB_STEP_SUMMARY

          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

# =============================================================================
# Documentation Generation (master-only, after all gates pass)
# =============================================================================
  generate-api-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest
    needs: [lint-openapi-redocly, lint-asyncapi]
    if: github.ref == 'refs/heads/master'
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Download OpenAPI specs
        uses: actions/download-artifact@v4.1.8
        with:
          name: openapi-specs
          path: openapi-specs

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install CLI tools (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            npm install -g @redocly/cli@${{ env.REDOCLY_CLI_VERSION }} --prefer-offline --no-audit --no-fund
            npm install -g @asyncapi/cli@${{ env.ASYNCAPI_CLI_VERSION }} --prefer-offline --no-audit --no-fund

      - name: Generate OpenAPI HTML docs
        run: |
          mkdir -p build/api-docs/openapi
          specs=$(find openapi-specs \( -name 'openapi.yaml' -o -name 'openapi.yml' -o -name 'openapi.json' \))
          for spec in $specs; do
            module=$(echo $spec | sed -E 's|.*/([^/]+)/build/openapi/.*|\1|')
            echo "üìÑ Generating OpenAPI docs for: $module"
            redocly build-docs "$spec" --output="build/api-docs/openapi/$module.html"
          done

      - name: Generate AsyncAPI HTML docs
        run: |
          mkdir -p build/api-docs/asyncapi
          for spec in config/asyncapi/*.yaml config/asyncapi/*.yml; do
            if [ -f "$spec" ]; then
              BASENAME=$(basename "$spec" | sed 's/\.[^.]*$//')
              echo "üìÑ Generating AsyncAPI docs for: $BASENAME"
              asyncapi generate fromTemplate "$spec" @asyncapi/html-template \
                -o "build/api-docs/asyncapi/$BASENAME" --force-write || true
            fi
          done

      - name: Upload API documentation
        uses: actions/upload-artifact@v4.3.6
        with:
          name: api-documentation
          path: build/api-docs/
          retention-days: 30

# =============================================================================
# Breaking Change Detection (PR-only)
# =============================================================================
  breaking-change-check:
    name: Breaking Change Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [lint-openapi-redocly, lint-asyncapi]
    timeout-minutes: 10

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4.1.7
        with:
          path: pr-branch

      - name: Checkout base branch
        uses: actions/checkout@v4.1.7
        with:
          ref: ${{ github.base_ref }}
          path: base-branch

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install AsyncAPI CLI (with retry)
        uses: nick-fields/retry@v3.0.0
        with:
          timeout_minutes: 3
          max_attempts: 3
          retry_wait_seconds: 10
          command: npm install -g @asyncapi/cli@${{ env.ASYNCAPI_CLI_VERSION }} --prefer-offline --no-audit --no-fund

      - name: Check AsyncAPI breaking changes
        run: |
          echo "### Breaking Change Analysis" >> $GITHUB_STEP_SUMMARY
          BREAKING=0

          for spec in pr-branch/config/asyncapi/*.yaml pr-branch/config/asyncapi/*.yml; do
            if [ -f "$spec" ]; then
              BASENAME=$(basename "$spec")
              BASE_SPEC="base-branch/config/asyncapi/$BASENAME"

              if [ -f "$BASE_SPEC" ]; then
                echo "üìã Comparing: $BASENAME"
                if asyncapi diff "$BASE_SPEC" "$spec" --overrides breaking=fail 2>&1; then
                  echo "‚úÖ No breaking changes in: $BASENAME"
                else
                  echo "‚ö†Ô∏è Potential breaking changes in: $BASENAME"
                  BREAKING=$((BREAKING + 1))
                fi
              else
                echo "üìù New spec: $BASENAME (no base to compare)"
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Specs with breaking changes:** $BREAKING" >> $GITHUB_STEP_SUMMARY

          if [ $BREAKING -gt 0 ]; then
            echo "‚ö†Ô∏è Breaking changes detected ‚Äî please review carefully"
            echo "Consider semantic versioning for event schemas"
          fi
