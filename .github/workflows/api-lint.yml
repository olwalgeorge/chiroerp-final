name: API Governance - Lint OpenAPI Specs

on:
  pull_request:
    branches: [master, develop]
    paths:
      - 'bounded-contexts/**/src/main/kotlin/**/*Controller.kt'
      - 'bounded-contexts/**/src/main/kotlin/**/*Resource.kt'
      - 'bounded-contexts/**/src/main/kotlin/**/infrastructure/web/**/*.kt'
      - '.redocly.yaml'
      - '.github/workflows/api-lint.yml'
      - 'config/openapi/application-openapi.properties'
  push:
    branches: [master, develop]

env:
  REDOCLY_CLI_VERSION: '1.25.5'
  SPECTRAL_CLI_VERSION: '6.11.1'
  OASDIFF_VERSION: '1.10.23'

jobs:
  generate-specs:
    name: Generate OpenAPI Specifications
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      - name: Generate OpenAPI specs
        run: ./gradlew generateOpenApiSpecs --parallel
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"
      - name: List generated OpenAPI specs
        run: |
          echo "### Generated OpenAPI Specifications" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find . \( -path '*/build/openapi/openapi.yaml' -o -path '*/build/openapi/openapi.yml' -o -path '*/build/openapi/openapi.json' \) >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      - name: Upload OpenAPI specs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-specs
          path: |
            **/build/openapi/openapi.yaml
            **/build/openapi/openapi.yml
            **/build/openapi/openapi.json
          retention-days: 30

  lint-redocly:
    name: Lint with Redocly CLI
    needs: generate-specs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download OpenAPI specs
        uses: actions/download-artifact@v4
        with:
          name: openapi-specs
          path: openapi-specs
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Redocly CLI
        run: npm install -g @redocly/cli@${{ env.REDOCLY_CLI_VERSION }} --prefer-offline --no-audit --no-fund
      - name: Lint all OpenAPI specs
        id: redocly-lint
        run: |
          echo "### Redocly Lint Results" >> $GITHUB_STEP_SUMMARY
          specs=$(find openapi-specs \( -name 'openapi.yaml' -o -name 'openapi.yml' -o -name 'openapi.json' \))
          if [ -z "$specs" ]; then
            echo "No OpenAPI specs found to lint" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          spec_count=$(echo "$specs" | wc -w | tr -d ' ')
          echo "Linting $spec_count spec(s)" >> $GITHUB_STEP_SUMMARY
          redocly lint $specs --format=stylish
        continue-on-error: false

  lint-spectral:
    name: Lint with Spectral
    needs: generate-specs
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download OpenAPI specs
        uses: actions/download-artifact@v4
        with:
          name: openapi-specs
          path: openapi-specs
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Spectral
        run: npm install -g @stoplight/spectral-cli@${{ env.SPECTRAL_CLI_VERSION }} --prefer-offline --no-audit --no-fund
      - name: Create Spectral ruleset
        run: |
          cat > .spectral.yaml << 'EOF'
          extends: spectral:oas
          rules:
            operation-success-response: error
            operation-operationId: error
            operation-description: error
          EOF
      - name: Lint with Spectral
        run: |
          specs=$(find openapi-specs \( -name 'openapi.yaml' -o -name 'openapi.yml' -o -name 'openapi.json' \))
          for spec in $specs; do
            echo "### Spectral: $spec" >> $GITHUB_STEP_SUMMARY
            spectral lint "$spec" --format=stylish || true
          done

  generate-docs:
    name: Generate Static API Docs
    needs: [lint-redocly]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download OpenAPI specs
        uses: actions/download-artifact@v4
        with:
          name: openapi-specs
          path: openapi-specs
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Redocly CLI
        run: npm install -g @redocly/cli@${{ env.REDOCLY_CLI_VERSION }} --prefer-offline --no-audit --no-fund
      - name: Generate Redoc static HTML docs
        run: |
          mkdir -p docs/api
          specs=$(find openapi-specs \( -name 'openapi.yaml' -o -name 'openapi.yml' -o -name 'openapi.json' \))
          for spec in $specs; do
            module=$(echo $spec | sed -E 's|.*/([^/]+)/build/openapi/.*|\1|')
            echo "Generating docs for $module from $spec"
            redocly build-docs "$spec" --output="docs/api/$module.html"
          done
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: docs/api/*.html
          retention-days: 90
