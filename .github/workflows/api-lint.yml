name: API Governance - Lint OpenAPI Specs

on:
  pull_request:
    branches: [master, develop]
    paths:
      - 'bounded-contexts/**/src/main/kotlin/**/*Controller.kt'
      - 'bounded-contexts/**/src/main/kotlin/**/*Resource.kt'
      - 'bounded-contexts/**/src/main/kotlin/**/infrastructure/web/**/*.kt'
      - '.redocly.yaml'
      - '.github/workflows/api-lint.yml'
      - 'config/openapi/application-openapi.properties'
  push:
    branches: [master, develop]

env:
  # Pin CLI versions to avoid @latest drift and ensure reproducible builds
  # Check for updates: https://www.npmjs.com/package/@redocly/cli
  REDOCLY_CLI_VERSION: '1.25.5'
  # Check for updates: https://www.npmjs.com/package/@stoplight/spectral-cli
  SPECTRAL_CLI_VERSION: '6.11.1'
  # Check for updates: https://www.npmjs.com/package/@tufin/oasdiff
  OASDIFF_VERSION: '1.10.23'

jobs:
  # ============================================================================
  # Generate OpenAPI Specs from Code
  # ============================================================================
  generate-specs:
    name: Generate OpenAPI Specifications
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      
      - name: Generate OpenAPI specs
        run: ./gradlew generateOpenApiSpecs --parallel
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"
      
      - name: List generated OpenAPI specs
        run: |
          echo "### Generated OpenAPI Specifications" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find . \( -path '*/build/openapi/openapi.yaml' -o -path '*/build/openapi/openapi.yml' -o -path '*/build/openapi/openapi.json' \) >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Upload OpenAPI specs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-specs
          path: |
            **/build/openapi/openapi.yaml
            **/build/openapi/openapi.yml
            **/build/openapi/openapi.json
          retention-days: 30

  # ============================================================================
  # Lint OpenAPI Specs with Redocly
  # ============================================================================
  lint-redocly:
    name: Lint with Redocly CLI
    needs: generate-specs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download OpenAPI specs
        uses: actions/download-artifact@v4
        with:
          name: openapi-specs
          path: openapi-specs
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Redocly CLI
        run: npm install -g @redocly/cli@${{ env.REDOCLY_CLI_VERSION }} --prefer-offline --no-audit --no-fund
      
      - name: Lint all OpenAPI specs
        id: redocly-lint
        run: |
          echo "### Redocly Lint Results" >> $GITHUB_STEP_SUMMARY
          
          # Find all generated specs
          specs=$(find openapi-specs \( -name 'openapi.yaml' -o -name 'openapi.yml' -o -name 'openapi.json' \))
          
          if [ -z "$specs" ]; then
            echo "âš ï¸ No OpenAPI specs found to lint" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          spec_count=$(echo "$specs" | wc -w | tr -d ' ')
          echo "Linting $spec_count spec(s) in one Redocly run" >> $GITHUB_STEP_SUMMARY
          redocly lint $specs --format=stylish
        continue-on-error: false
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ API Governance Check Failed
              
              Your OpenAPI specifications contain errors or violate design rules.
              
              **Action Required:**
              1. Review the [Redocly lint output](${context.payload.pull_request.html_url}/checks) above
              2. Fix errors in your JAX-RS resource classes
              3. Add missing \`@Operation\`, \`@Schema\`, or \`@Parameter\` annotations
              4. Re-run checks: \`./gradlew generateOpenApiSpecs && redocly lint openapi-specs/**/openapi.yaml\`
              
              **Common Issues:**
              - Missing operation descriptions
              - Undefined operation IDs
              - Missing parameter documentation
              - No 2xx response defined
              
              See \`config/openapi/application-openapi.properties\` for guidance.`
            })

  # ============================================================================
  # Breaking Change Detection (PR only)
  # ============================================================================
  breaking-change-check:
    name: Detect Breaking API Changes
    needs: generate-specs
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          path: pr-branch
      
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base-branch
      
      - name: Download PR OpenAPI specs
        uses: actions/download-artifact@v4
        with:
          name: openapi-specs
          path: pr-specs
      
      - name: Set up JDK 21 for base branch build
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Generate base branch OpenAPI specs
        working-directory: base-branch
        run: |
          chmod +x ./gradlew
          ./gradlew generateOpenApiSpecs --parallel || echo "Base branch may not have OpenAPI generation"
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"
        continue-on-error: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install oasdiff
        run: npm install -g oasdiff@${{ env.OASDIFF_VERSION }} --prefer-offline --no-audit --no-fund
      
      - name: Check for breaking changes
        id: breaking-check
        run: |
          echo "### ðŸ” API Breaking Change Analysis" >> $GITHUB_STEP_SUMMARY
          
          # Find specs in both branches
          pr_specs=$(find pr-specs \( -name 'openapi.yaml' -o -name 'openapi.yml' -o -name 'openapi.json' \) 2>/dev/null || echo "")
          base_specs=$(find base-branch \( -path '*/build/openapi/openapi.yaml' -o -path '*/build/openapi/openapi.yml' -o -path '*/build/openapi/openapi.json' \) 2>/dev/null || echo "")
          
          if [ -z "$base_specs" ]; then
            echo "â„¹ï¸ No base branch specs found (new API or first OpenAPI adoption). Skipping breaking change check." >> $GITHUB_STEP_SUMMARY
            echo "has_breaking_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          breaking_found=false
          
          for pr_spec in $pr_specs; do
            # Extract module name
            module=$(echo $pr_spec | sed -E 's|.*/([^/]+)/build/openapi/.*|\1|' | sed 's|pr-specs/||')
            
            # Find matching base spec
            base_spec=$(echo "$base_specs" | grep -E "/$module/build/openapi/" | head -1 || echo "")
            
            if [ -z "$base_spec" ]; then
              echo "â„¹ï¸ **$module**: New API (no base to compare)" >> $GITHUB_STEP_SUMMARY
              continue
            fi
            
            echo "#### Module: $module" >> $GITHUB_STEP_SUMMARY
            echo "Comparing:" >> $GITHUB_STEP_SUMMARY
            echo "- Base: \`$base_spec\`" >> $GITHUB_STEP_SUMMARY
            echo "- PR: \`$pr_spec\`" >> $GITHUB_STEP_SUMMARY
            
            # Run oasdiff breaking check
            if oasdiff breaking "$base_spec" "$pr_spec" --fail-on ERR 2>&1; then
              echo "âœ… No breaking changes detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **Breaking changes detected!**" >> $GITHUB_STEP_SUMMARY
              oasdiff breaking "$base_spec" "$pr_spec" --format text >> $GITHUB_STEP_SUMMARY 2>&1 || true
              breaking_found=true
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "has_breaking_changes=$breaking_found" >> $GITHUB_OUTPUT
          
          if [ "$breaking_found" = "true" ]; then
            echo "::warning::Breaking API changes detected. Review required."
          fi
      
      - name: Comment PR with breaking changes
        if: steps.breaking-check.outputs.has_breaking_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âš ï¸ Breaking API Changes Detected
              
              This PR introduces **breaking changes** to the OpenAPI contract.
              
              **What this means:**
              - Existing API clients may break
              - This requires a major version bump or deprecation period
              
              **Required Actions:**
              1. Review the breaking changes in the [workflow summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              2. If intentional:
                 - Add \`api-breaking-change\` label to acknowledge
                 - Update API version (e.g., \`/api/v1\` â†’ \`/api/v2\`)
                 - Document migration path for clients
              3. If unintentional:
                 - Revert the breaking changes
                 - Use additive changes instead (new endpoints, optional fields)
              
              **Common Breaking Changes:**
              - Removing endpoints or operations
              - Renaming required fields
              - Changing field types
              - Adding new required fields
              - Removing enum values
              
              See [ADR-010](docs/adr/ADR-010-rest-validation-standard.md) for API versioning policy.`
            })

  # ============================================================================
  # Lint with Spectral (Alternative/Additional Linter)
  # ============================================================================
  lint-spectral:
    name: Lint with Spectral
    needs: generate-specs
    runs-on: ubuntu-latest
    continue-on-error: true  # Spectral is supplementary to Redocly
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download OpenAPI specs
        uses: actions/download-artifact@v4
        with:
          name: openapi-specs
          path: openapi-specs
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Spectral
        run: npm install -g @stoplight/spectral-cli@${{ env.SPECTRAL_CLI_VERSION }} --prefer-offline --no-audit --no-fund
      
      - name: Create Spectral ruleset
        run: |
          cat > .spectral.yaml << 'EOF'
          extends: spectral:oas
          rules:
            operation-success-response: error
            operation-operationId: error
            operation-description: error
            operation-tag-defined: error
            oas3-api-servers: error
            info-contact: error
            info-description: error
          EOF
      
      - name: Lint with Spectral
        run: |
          specs=$(find openapi-specs \( -name 'openapi.yaml' -o -name 'openapi.yml' -o -name 'openapi.json' \))
          for spec in $specs; do
            echo "### Spectral: $spec" >> $GITHUB_STEP_SUMMARY
            spectral lint "$spec" --format=stylish || true
          done

  # ============================================================================
  # Generate Static Documentation (on main branch only)
  # ============================================================================
  generate-docs:
    name: Generate Static API Docs
    needs: [lint-redocly]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download OpenAPI specs
        uses: actions/download-artifact@v4
        with:
          name: openapi-specs
          path: openapi-specs
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Redocly CLI
        run: npm install -g @redocly/cli@${{ env.REDOCLY_CLI_VERSION }} --prefer-offline --no-audit --no-fund
      
      - name: Generate Redoc static HTML docs
        run: |
          mkdir -p docs/api
          
          # Generate docs for each spec
          specs=$(find openapi-specs \( -name 'openapi.yaml' -o -name 'openapi.yml' -o -name 'openapi.json' \))
          for spec in $specs; do
            # Extract module name (e.g., finance-gl)
            module=$(echo $spec | sed -E 's|.*/([^/]+)/build/openapi/.*|\1|')
            echo "Generating docs for $module from $spec"
            redocly build-docs "$spec" --output="docs/api/$module.html"
          done
      
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: docs/api/*.html
          retention-days: 90
      
      - name: Deploy to GitHub Pages (optional)
        # Uncomment if you want to publish docs to GitHub Pages
        # uses: peaceiris/actions-gh-pages@v3
        # with:
        #   github_token: ${{ secrets.GITHUB_TOKEN }}
        #   publish_dir: ./docs/api
        #   destination_dir: api
        run: echo "Docs generated. Configure GitHub Pages deployment if needed."
